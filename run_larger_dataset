#!/bin/bash

mvn clean package shade:shade -DskipTests

#  /media/disk2/Xia/GitHubProjects/3Clone/NewDown2018/V141/3095/buggy-version
# /media/disk2/Xia/GitHubProjects/3Clone/NewDown2018

listFilePairs() {
    part=$2
    for archiveInfo in $1/$part/*/archiveInfo.txt; do
	projName=$(head -n 1 $archiveInfo | awk 'BEGIN{FS="/"} {print tolower($6)}')
	if [ $projName == "chart" ] || [ $projName == "closure" ] || [ $projName == "math" ] || [ $projName == "lang" ] || [ $projName == "time" ] || [ $projName == "mockito" ] || [ $projName == "commonscli" ] || [ $projName == "commonscodec" ] || [ $projName == "commonscsv" ] || [ $projName == "commonsjxpath" ] || [ $projName == "jacksoncore" ] || [ $projName == "jacksondatabind" ] || [ $projName == "jacksonxml" ] || [ $projName == "jsoup" ]
	then
	    echo "ignored $projName" > /dev/null
	else
	    section=$(basename $(dirname $archiveInfo))
	    if [ -d $1/$part/$section/buggy-version ]; then
		for buggyFilePath in $1/$part/$section/buggy-version/*.java; do
		    fileName=$(basename $buggyFilePath)
		    basePath=$(dirname $(dirname $buggyFilePath))
		    fixedFilePath=$basePath"/fixed-version/"$fileName
		    echo $buggyFilePath","$fixedFilePath
		done
	    fi
	fi
    done
}

basePath=/media/disk2/Xia/GitHubProjects/3Clone/NewDown2018

for partPath in $basePath/V*/; do
    part=$(basename $partPath)
    # time-out = 15 minutes
    listFilePairs $basePath $part | java -cp target/fix-pattern-miner-1.0.0-SNAPSHOT.jar edu.utdallas.fpm.main.Main -p -t 900
    mv out-general.csv $part".csv"
done
