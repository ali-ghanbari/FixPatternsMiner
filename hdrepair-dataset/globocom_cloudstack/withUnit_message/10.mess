fix CLOUDSTACK-2149 and related unit test

