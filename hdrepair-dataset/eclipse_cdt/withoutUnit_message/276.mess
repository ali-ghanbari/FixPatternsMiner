Patch from Alex Chapiro to fix a bug

