fix #1667 - bugs in tests and so


Former-commit-id: 374e1ca8683fa4334477d9db24887ecbb5835ea9
