diff --git a/activemq-core/src/main/java/org/apache/activemq/broker/region/TopicSubscription.java b/activemq-core/src/main/java/org/apache/activemq/broker/region/TopicSubscription.java
index 87f7a80..17e934f 100755
--- a/activemq-core/src/main/java/org/apache/activemq/broker/region/TopicSubscription.java
+++ b/activemq-core/src/main/java/org/apache/activemq/broker/region/TopicSubscription.java
@@ -80 +80 @@
-        if (info.getDestination().isTemporary() || broker == null || broker.getTempDataStore()==null ) {
+        if (info.getDestination().isTemporary() || broker.getTempDataStore()==null ) {
diff --git a/activemq-core/src/test/java/org/apache/activemq/broker/policy/PriorityNetworkDispatchPolicyTest.java b/activemq-core/src/test/java/org/apache/activemq/broker/policy/PriorityNetworkDispatchPolicyTest.java
index 66e77ec..2441364 100644
--- a/activemq-core/src/test/java/org/apache/activemq/broker/policy/PriorityNetworkDispatchPolicyTest.java
+++ b/activemq-core/src/test/java/org/apache/activemq/broker/policy/PriorityNetworkDispatchPolicyTest.java
@@ -20,0 +21 @@
+import org.apache.activemq.broker.BrokerService;
@@ -29,0 +31,2 @@
+import org.apache.derby.iapi.jdbc.BrokeredStatement;
+import org.junit.After;
@@ -43,0 +47 @@
+    BrokerService brokerService = new BrokerService();
@@ -52,0 +57,5 @@
+    @After
+    public void stopBroker() throws Exception {
+        brokerService.stop();
+    }
+
@@ -54,0 +64 @@
+
@@ -60 +70 @@
-            consumers.add(new TopicSubscription(null, context, instance, usageManager));
+            consumers.add(new TopicSubscription(brokerService.getBroker(), context, instance, usageManager));

