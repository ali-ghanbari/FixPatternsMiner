Cherry-pick from pveentjer: More work on fixing the tests + some cleanup

