More unit tests + bug fixes

