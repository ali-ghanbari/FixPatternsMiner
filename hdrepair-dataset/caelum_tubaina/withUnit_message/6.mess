fixing ifdef option and adding tests

