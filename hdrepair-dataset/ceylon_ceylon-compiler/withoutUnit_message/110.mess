Redoing fix c28e12c80af666a2569cbeb76e4b49e90b9740d0 for #550 in a slightly more correct way

