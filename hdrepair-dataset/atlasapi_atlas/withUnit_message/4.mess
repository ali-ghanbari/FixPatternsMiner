Add new tests and fix existing ones.

