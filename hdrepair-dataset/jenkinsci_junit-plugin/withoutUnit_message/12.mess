[FIXED HUDSON-2771] fixed NPE, and added a regression test, which in turn required some fixes in HtmlUnit as well.

git-svn-id: https://hudson.dev.java.net/svn/hudson/trunk/hudson/main@13936 71c3de6d-444a-0410-be80-ed276b4c234a

