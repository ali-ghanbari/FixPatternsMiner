Upgrading a file no longer loses the file name.

Instead, upgrading is seamless - the user doesn't need to know the file
was upgraded.

This fixes #265.

