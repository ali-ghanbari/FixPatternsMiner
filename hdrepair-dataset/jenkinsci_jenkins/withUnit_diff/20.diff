diff --git a/core/src/main/java/hudson/util/XStream2.java b/core/src/main/java/hudson/util/XStream2.java
index e0b743f..d484f43 100644
--- a/core/src/main/java/hudson/util/XStream2.java
+++ b/core/src/main/java/hudson/util/XStream2.java
@@ -116 +116 @@
-                if (ImmutableMap.class.isAssignableFrom(type))
+                if (type != null && ImmutableMap.class.isAssignableFrom(type))
diff --git a/core/src/test/java/hudson/util/XStream2Test.java b/core/src/test/java/hudson/util/XStream2Test.java
index 5b8cb53..1626aae 100644
--- a/core/src/test/java/hudson/util/XStream2Test.java
+++ b/core/src/test/java/hudson/util/XStream2Test.java
@@ -166,0 +167,6 @@
+
+    // @Bug(8006) -- Previously a null entry in an array caused NPE
+    public void testEmptyStack() {
+        assertEquals("<object-array><null/><null/></object-array>",
+                     Run.XSTREAM.toXML(new Object[2]).replaceAll("[ \n\r\t]+", ""));
+    }

