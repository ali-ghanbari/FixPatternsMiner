lots of fixes for replicaSet support

