[BZ 772318] forgot to test the most obvious and most common scenario - re-starting the agent. My original fix broke that. This fixes it back again and adds a unit test for it.

