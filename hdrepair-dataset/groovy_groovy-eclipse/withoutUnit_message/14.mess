Judging by tests the bug is partly fixed and can be merged to master.
