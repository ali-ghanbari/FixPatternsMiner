Template Formatting Engine refactoring and fixes

