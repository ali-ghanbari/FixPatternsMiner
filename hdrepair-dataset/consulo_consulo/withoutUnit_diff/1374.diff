diff --git a/platform/lang-impl/src/com/intellij/refactoring/actions/BaseRefactoringAction.java b/platform/lang-impl/src/com/intellij/refactoring/actions/BaseRefactoringAction.java
index 013d720..fafbd77 100644
--- a/platform/lang-impl/src/com/intellij/refactoring/actions/BaseRefactoringAction.java
+++ b/platform/lang-impl/src/com/intellij/refactoring/actions/BaseRefactoringAction.java
@@ -170 +170 @@
-    if (ActionPlaces.isPopupPlace(e.getPlace())) {
+    if (ActionPlaces.isPopupPlace(e.getPlace()) && e.getPresentation().isVisible()) {

