A few bug fixes and some cleanup.
