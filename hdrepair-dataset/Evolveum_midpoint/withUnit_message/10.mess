more fixed bugs, tests cleanup

