diff --git a/jbpm-flow/src/main/java/org/jbpm/marshalling/impl/AbstractProtobufProcessInstanceMarshaller.java b/jbpm-flow/src/main/java/org/jbpm/marshalling/impl/AbstractProtobufProcessInstanceMarshaller.java
index 3561117..c7ec218 100644
--- a/jbpm-flow/src/main/java/org/jbpm/marshalling/impl/AbstractProtobufProcessInstanceMarshaller.java
+++ b/jbpm-flow/src/main/java/org/jbpm/marshalling/impl/AbstractProtobufProcessInstanceMarshaller.java
@@ -290 +290 @@
-                    _composite.addVariable( ProtobufProcessMarshaller.marshallVariableSerializableStrategy( context, variable.getKey(), variable.getValue() ) );
+                    _composite.addVariable( ProtobufProcessMarshaller.marshallVariable( context, variable.getKey(), variable.getValue() ) );
diff --git a/jbpm-persistence-jpa/src/test/resources/VariablePersistenceStrategySubProcess.rf b/jbpm-persistence-jpa/src/test/resources/VariablePersistenceStrategySubProcess.rf
index 7081efe..f8c11ea 100644
--- a/jbpm-persistence-jpa/src/test/resources/VariablePersistenceStrategySubProcess.rf
+++ b/jbpm-persistence-jpa/src/test/resources/VariablePersistenceStrategySubProcess.rf
@@ -10,0 +11,2 @@
+      <import name="javax.persistence.EntityManager" />
+      <import name="org.drools.runtime.EnvironmentName" />
@@ -51,3 +53,10 @@
-        <action type="expression" dialect="mvel" >kcontext.setVariable("x", "new String");
-kcontext.setVariable("y", new MyEntity("This is a new test Entity"));
-kcontext.setVariable("z", new MyVariableSerializable("This is a new test SerializableObject"));</action>
+        <action type="expression" dialect="java" >
+        kcontext.setVariable("x", "new String");
+        EntityManager em = (EntityManager)kcontext.getKnowledgeRuntime().getEnvironment().get(EnvironmentName.APP_SCOPED_ENTITY_MANAGER);
+        MyEntity newEntity = new MyEntity("This is a new test Entity");
+        em.persist(newEntity);
+        kcontext.setVariable("y", newEntity);
+        MyVariableSerializable newSerializable = new MyVariableSerializable("This is a new test SerializableObject");
+        kcontext.setVariable("z", newSerializable);
+        
+        </action>
@@ -78 +87 @@
-        <action type="expression" dialect="mvel" >System.out.println("v = " + v);
+        <action type="expression" dialect="java" >System.out.println("v = " + v);
@@ -97 +106 @@
-        <action type="expression" dialect="mvel" >System.out.println("a = " + a);
+        <action type="expression" dialect="java" >System.out.println("a = " + a);
@@ -127 +136 @@
-        <action type="expression" dialect="mvel" >System.out.println("a = " + a);
+        <action type="expression" dialect="java" >System.out.println("a = " + a);

